<!DOCTYPE html>
<html lang="en" class="h-full" :class="{ 'dark': darkMode }" x-data="dashboard()">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Control Plane | Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: { luxury: { 500: '#435df0', 600: '#2e3ee4' } }
                }
            }
        }
    </script>
    <style>
        [x-cloak] { display: none !important; }
        .glass { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(8px); border: 1px solid rgba(0, 0, 0, 0.1); }
        .dark .glass { background: rgba(15, 23, 42, 0.7); border: 1px solid rgba(255, 255, 255, 0.1); }
        .luxury-gradient { background: linear-gradient(135deg, #435df0 0%, #a855f7 100%); }
    </style>
</head>
<body class="h-full bg-slate-50 dark:bg-slate-950 text-slate-900 dark:text-slate-100 transition-colors duration-200">
    <!-- Auth Modal -->
    <div x-show="!adminKey" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/80 p-4">
        <div class="bg-white dark:bg-slate-900 p-8 rounded-2xl shadow-2xl max-w-sm w-full">
            <h2 class="text-2xl font-bold mb-6 text-center">Admin Access</h2>
            <form @submit.prevent="saveKey" class="space-y-4">
                <input type="password" x-model="keyInput" placeholder="Enter Admin Key" class="w-full p-3 rounded-xl border dark:bg-slate-800 dark:border-slate-700">
                <button type="submit" class="w-full luxury-gradient text-white py-3 rounded-xl font-bold shadow-lg">Login</button>
            </form>
        </div>
    </div>

    <div x-show="adminKey" x-cloak class="flex h-full">
        <!-- Sidebar -->
        <aside class="w-64 bg-white dark:bg-slate-900 border-r dark:border-slate-800 flex flex-col">
            <div class="p-6 font-bold text-xl flex items-center gap-2">
                <div class="w-8 h-8 luxury-gradient rounded-lg flex items-center justify-center text-white"><i class="fa-solid fa-bolt text-sm"></i></div>
                AI Control
            </div>
            <nav class="flex-1 px-4 space-y-1">
                <button @click="view = 'users'" :class="view === 'users' ? 'bg-slate-100 dark:bg-slate-800 text-blue-600' : ''" class="w-full text-left px-4 py-3 rounded-xl font-medium flex items-center gap-3 transition"><i class="fa-solid fa-users"></i> Users</button>
                <button @click="view = 'groups'" :class="view === 'groups' ? 'bg-slate-100 dark:bg-slate-800 text-blue-600' : ''" class="w-full text-left px-4 py-3 rounded-xl font-medium flex items-center gap-3 transition"><i class="fa-solid fa-layer-group"></i> Group Logic</button>
                <button @click="view = 'policies'" :class="view === 'policies' ? 'bg-slate-100 dark:bg-slate-800 text-blue-600' : ''" class="w-full text-left px-4 py-3 rounded-xl font-medium flex items-center gap-3 transition"><i class="fa-solid fa-shield-halved"></i> Quota Policies</button>
                <button @click="view = 'logs'" :class="view === 'logs' ? 'bg-slate-100 dark:bg-slate-800 text-blue-600' : ''" class="w-full text-left px-4 py-3 rounded-xl font-medium flex items-center gap-3 transition"><i class="fa-solid fa-list-ul"></i> Logs</button>
            </nav>
            <div class="p-4 border-t dark:border-slate-800">
                <button @click="toggleTheme" class="w-full p-2 rounded-lg bg-slate-100 dark:bg-slate-800 mb-2"><i class="fa-solid" :class="darkMode ? 'fa-sun text-yellow-400' : 'fa-moon'"></i></button>
                <button @click="logout" class="w-full text-red-500 text-sm font-bold">Logout</button>
            </div>
        </aside>

        <!-- Content -->
        <main class="flex-1 overflow-y-auto p-8">
            <header class="flex justify-between items-center mb-8">
                <h1 class="text-3xl font-bold capitalize" x-text="view"></h1>
                <button @click="refreshAll" class="px-4 py-2 bg-white dark:bg-slate-800 border dark:border-slate-700 rounded-xl shadow-sm hover:shadow-md transition">Sync Data</button>
            </header>

            <!-- USERS VIEW -->
            <div x-show="view === 'users'">
                <div class="glass rounded-2xl overflow-hidden shadow-lg">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-slate-50 dark:bg-slate-800/50 text-xs font-bold uppercase text-slate-500">
                            <tr><th class="p-4">User</th><th class="p-4">Status</th><th class="p-4">Policy</th><th class="p-4 text-right">Actions</th></tr>
                        </thead>
                        <tbody class="divide-y dark:divide-slate-800">
                            <template x-for="user in users" :key="user.id">
                                <tr class="text-sm">
                                    <td class="p-4 font-semibold" x-text="user.id"></td>
                                    <td class="p-4">
                                        <button @click="toggleUserStatus(user)" :class="user.is_active ? 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400' : 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400'" class="px-2 py-1 rounded-md text-[10px] font-bold uppercase" x-text="user.is_active ? 'Active' : 'Banned'"></button>
                                    </td>
                                    <td class="p-4">
                                        <select x-model="user.policy_id" @change="updateUserPolicy(user)" class="bg-transparent border-b border-slate-200 dark:border-slate-700 font-bold outline-none">
                                            <template x-for="p in policies" :key="p.id"><option :value="p.id" x-text="p.name"></option></template>
                                        </select>
                                    </td>
                                    <td class="p-4 text-right"><button @click="toggleUserStatus(user)" class="text-slate-400 hover:text-red-500"><i class="fa-solid fa-ban"></i></button></td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- GROUPS VIEW -->
            <div x-show="view === 'groups'">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="glass p-6 rounded-2xl shadow-lg border-blue-500/20">
                        <h3 class="font-bold mb-4">Link Group to Policy</h3>
                        <form @submit.prevent="saveGroupPolicy" class="space-y-4">
                            <label class="block text-xs font-bold text-slate-500 uppercase">OpenWebUI Group</label>
                            <select x-model="newGroupPolicy.group_name" class="w-full p-2 rounded-lg border dark:bg-slate-800 dark:border-slate-700">
                                <option value="">-- Select --</option>
                                <template x-for="g in webuiGroups" :key="g.name"><option :value="g.name" x-text="g.name"></option></template>
                            </select>
                            <label class="block text-xs font-bold text-slate-500 uppercase">Middleware Policy</label>
                            <select x-model="newGroupPolicy.policy_id" class="w-full p-2 rounded-lg border dark:bg-slate-800 dark:border-slate-700">
                                <option value="">-- Select --</option>
                                <template x-for="p in policies" :key="p.id"><option :value="p.id" x-text="p.name"></option></template>
                            </select>
                            <label class="block text-xs font-bold text-slate-500 uppercase">Priority</label>
                            <input type="number" x-model.number="newGroupPolicy.priority" class="w-full p-2 rounded-lg border dark:bg-slate-800 dark:border-slate-700">
                            <button type="submit" class="w-full luxury-gradient text-white py-2 rounded-lg font-bold">Save Mapping</button>
                        </form>
                    </div>
                    <div class="lg:col-span-2 glass rounded-2xl overflow-hidden shadow-lg">
                        <table class="w-full text-left">
                            <thead class="bg-slate-50 dark:bg-slate-800/50 text-xs font-bold uppercase text-slate-500">
                                <tr><th class="p-4">Group</th><th class="p-4">Policy</th><th class="p-4">Priority</th><th class="p-4 text-right">Action</th></tr>
                            </thead>
                            <tbody class="divide-y dark:divide-slate-800">
                                <template x-for="gp in groupPolicies" :key="gp.group_name">
                                    <tr class="text-sm">
                                        <td class="p-4 font-bold" x-text="gp.group_name"></td>
                                        <td class="p-4 text-blue-500 font-bold" x-text="gp.policy_id"></td>
                                        <td class="p-4" x-text="gp.priority"></td>
                                        <td class="p-4 text-right"><button @click="deleteGroupMapping(gp.group_name)" class="text-red-400 hover:text-red-600"><i class="fa-solid fa-trash"></i></button></td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- POLICIES VIEW -->
            <div x-show="view === 'policies'">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="glass p-6 rounded-2xl shadow-lg border-purple-500/20">
                        <h3 class="font-bold mb-4">Upsert Quota Policy</h3>
                        <form @submit.prevent="createPolicy" class="space-y-4 text-slate-900 dark:text-white">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Policy ID</label>
                                <input type="text" x-model="newPolicy.id" placeholder="e.g. vip-class" class="w-full p-2 rounded-lg border dark:bg-slate-800 dark:border-slate-700 text-slate-900 dark:text-white">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Display Name</label>
                                <input type="text" x-model="newPolicy.name" placeholder="e.g. High Performance Tier" class="w-full p-2 rounded-lg border dark:bg-slate-800 dark:border-slate-700 text-slate-900 dark:text-white">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Daily Token</label>
                                    <input type="number" x-model.number="newPolicy.daily_token_limit" class="w-full p-2 rounded-lg border dark:bg-slate-800 dark:border-slate-700 text-slate-900 dark:text-white">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Monthly Token</label>
                                    <input type="number" x-model.number="newPolicy.monthly_token_limit" class="w-full p-2 rounded-lg border dark:bg-slate-800 dark:border-slate-700 text-slate-900 dark:text-white">
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Allowed Models (CSV or *)</label>
                                <input type="text" x-model="newPolicy.allowed_models" class="w-full p-2 rounded-lg border dark:bg-slate-800 dark:border-slate-700 text-slate-900 dark:text-white">
                            </div>
                            <button type="submit" class="w-full luxury-gradient text-white py-2 rounded-lg font-bold shadow-md">Execute Upsert</button>
                        </form>
                    </div>
                    <div class="lg:col-span-2 glass rounded-2xl overflow-hidden shadow-lg">
                        <table class="w-full text-left">
                            <thead class="bg-slate-50 dark:bg-slate-800/50 text-xs font-bold uppercase text-slate-500">
                                <tr><th class="p-4">Policy Name</th><th class="p-4">Limits (D/M)</th><th class="p-4">Models</th><th class="p-4 text-right">Delete</th></tr>
                            </thead>
                            <tbody class="divide-y dark:divide-slate-800">
                                <template x-for="p in policies" :key="p.id">
                                    <tr class="text-sm">
                                        <td class="p-4"><div class="font-bold" x-text="p.name"></div><div class="text-[10px] text-slate-400 font-mono" x-text="p.id"></div></td>
                                        <td class="p-4 font-mono" x-text="(p.daily_token_limit == -1 ? '∞' : formatNumber(p.daily_token_limit)) + ' / ' + (p.monthly_token_limit == -1 ? '∞' : formatNumber(p.monthly_token_limit))"></td>
                                        <td class="p-4 text-xs text-slate-400 max-w-[150px] truncate" x-text="p.allowed_models"></td>
                                        <td class="p-4 text-right"><button @click="deletePolicy(p.id)" class="text-slate-300 hover:text-red-500" x-show="p.id !== 'default'"><i class="fa-solid fa-trash-can"></i></button></td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- LOGS VIEW -->
            <div x-show="view === 'logs'">
                <div class="glass rounded-2xl overflow-hidden shadow-lg">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50 dark:bg-slate-800/50 text-xs font-bold uppercase text-slate-500">
                            <tr><th class="p-4">Time</th><th class="p-4">User</th><th class="p-4">Model</th><th class="p-4 text-center">Tokens</th><th class="p-4 text-right">Cost</th></tr>
                        </thead>
                        <tbody class="divide-y dark:divide-slate-800 font-mono text-[11px]">
                            <template x-for="log in usage" :key="log.id">
                                <tr class="hover:bg-slate-50 dark:hover:bg-slate-800/20">
                                    <td class="p-4 text-slate-400" x-text="formatDateTimeShort(log.ts)"></td>
                                    <td class="p-4 font-bold" x-text="log.user_id"></td>
                                    <td class="p-4 text-blue-400" x-text="log.model.split('/')[1] || log.model"></td>
                                    <td class="p-4 text-center" x-text="formatNumber(log.total_tokens)"></td>
                                    <td class="p-4 text-right font-bold text-emerald-500" x-text="'$' + parseFloat(log.total_cost || 0).toFixed(6)"></td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script>
        function dashboard() {
            return {
                view: 'users',
                darkMode: localStorage.getItem('theme') === 'dark',
                adminKey: localStorage.getItem('adminKey') || '',
                keyInput: '',
                loading: false,
                users: [], policies: [], groupPolicies: [], webuiGroups: [], usage: [],
                newPolicy: { id: '', name: '', daily_token_limit: 50000, monthly_token_limit: 1000000, allowed_models: '*' },
                newGroupPolicy: { group_name: '', policy_id: '', priority: 0 },
                stats: { totalUsers: 0, totalPolicies: 0, totalCost: 0, totalTokens: 0 },

                async init() {
                    if (this.adminKey) {
                        await this.refreshAll();
                        setInterval(() => this.refreshAll(), 15000);
                    }
                },

                toggleTheme() {
                    this.darkMode = !this.darkMode;
                    localStorage.setItem('theme', this.darkMode ? 'dark' : 'light');
                },

                saveKey() { this.adminKey = this.keyInput; localStorage.setItem('adminKey', this.adminKey); this.init(); },
                logout() { this.adminKey = ''; localStorage.removeItem('adminKey'); },

                async refreshAll() {
                    this.loading = true;
                    try {
                        const headers = { 'x-admin-key': this.adminKey };
                        const [u, p, log, gps, wgs] = await Promise.all([
                            fetch('/admin/users', { headers }).then(r => r.json()),
                            fetch('/admin/policies', { headers }).then(r => r.json()),
                            fetch('/admin/usage', { headers }).then(r => r.json()),
                            fetch('/admin/group-policies', { headers }).then(r => r.json()),
                            fetch('/admin/openwebui-groups', { headers }).then(r => r.json())
                        ]);
                        this.users = u; this.policies = p; this.usage = log;
                        this.groupPolicies = gps; this.webuiGroups = wgs;
                    } catch (e) { console.error(e); } finally { this.loading = false; }
                },

                async toggleUserStatus(user) {
                    await fetch(`/admin/users/${user.id}`, { method: 'PATCH', headers: { 'x-admin-key': this.adminKey, 'Content-Type': 'application/json' }, body: JSON.stringify({ is_active: !user.is_active }) });
                    await this.refreshAll();
                },

                async updateUserPolicy(user) {
                    await fetch(`/admin/users/${user.id}`, { method: 'PATCH', headers: { 'x-admin-key': this.adminKey, 'Content-Type': 'application/json' }, body: JSON.stringify({ policy_id: user.policy_id }) });
                    await this.refreshAll();
                },

                async createPolicy() {
                    const res = await fetch('/admin/policies', { method: 'POST', headers: { 'x-admin-key': this.adminKey, 'Content-Type': 'application/json' }, body: JSON.stringify(this.newPolicy) });
                    if (res.ok) { this.newPolicy = { id: '', name: '', daily_token_limit: 50000, monthly_token_limit: 1000000, allowed_models: '*' }; await this.refreshAll(); }
                },

                async deletePolicy(id) {
                    if (!confirm('Delete?')) return;
                    await fetch(`/admin/policies/${id}`, { method: 'DELETE', headers: { 'x-admin-key': this.adminKey } });
                    await this.refreshAll();
                },

                async saveGroupPolicy() {
                    const res = await fetch('/admin/group-policies', { method: 'POST', headers: { 'x-admin-key': this.adminKey, 'Content-Type': 'application/json' }, body: JSON.stringify(this.newGroupPolicy) });
                    if (res.ok) { this.newGroupPolicy = { group_name: '', policy_id: '', priority: 0 }; await this.refreshAll(); }
                },

                async deleteGroupMapping(name) {
                    await fetch(`/admin/group-policies/${name}`, { method: 'DELETE', headers: { 'x-admin-key': this.adminKey } });
                    await this.refreshAll();
                },

                formatNumber(n) { return new Intl.NumberFormat().format(n); },
                formatDate(d) { return new Date(d).toLocaleDateString(); },
                formatDateTimeShort(d) { return new Date(d).toLocaleTimeString(); }
            }
        }
    </script>
</body>
</html>
